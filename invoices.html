<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZAtech CRM Portal - Invoices</title>

  <link rel="icon" type="image/png" href="assets/img/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/css/styles.css">

  <!-- App scripts (keep your order) -->
  <script type="module" src="./assets/js/firebase.js"></script>
  <script type="module" src="./assets/js/auth-guard.js"></script>
  <script type="module" src="./assets/js/idle.js"></script>
  <script defer src="./assets/js/app.js"></script>
  <script defer src="./assets/js/topbar.js"></script>

  <!-- keep these -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.2.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.44.0/build/docxtemplater.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- Supabase + page logic -->
  <script type="module" src="./assets/js/supabase.js"></script>
  <script type="module" src="./assets/js/invoices.js?v=3"></script>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="side">
    <div class="brand">
      <img src="./assets/img/zatech-logo.png" alt="ZAtech Logo" class="brand-logo" />
    </div>

    <nav class="nav" id="nav">
      <a href="./index.html"><img src="./assets/img/dashboard.png" class="nav-icon" alt=""><span class="txt">Dashboard</span></a>
      <a href="./clients.html"><img src="./assets/img/multiple-users-silhouette.png" class="nav-icon" alt=""><span class="txt">Clients</span></a>
      <a href="./invoices.html" class="active"><img src="./assets/img/file.png" class="nav-icon" alt=""><span class="txt">Invoices</span></a>
      <a href="./schedule.html"><img src="./assets/img/schedule.png" class="nav-icon" alt=""><span class="txt">Invoice Schedule</span></a>
      <a href="./revenue.html"><img src="./assets/img/increase.png" class="nav-icon" alt=""><span class="txt">Revenue</span></a>
      <a href="./dues.html"><img src="./assets/img/deadline.png" class="nav-icon" alt=""><span class="txt">Dues</span></a>
      <a href="./expenses.html"><img src="./assets/img/credit-card.png" class="nav-icon" alt=""><span class="txt">Expenses</span></a>
      <a href="./opps.html"><img src="./assets/img/rocket.png" class="nav-icon" alt=""><span class="txt">Opportunities</span></a>
      <a href="./settings.html"><img src="./assets/img/gear.png" class="nav-icon" alt=""><span class="txt">Settings</span></a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div id="contentLoader" aria-hidden="true">
      <div class="loader-wrap">
        <div class="loader-ring"></div>
        <div class="loader-text">Loading dataâ€¦</div>
      </div>
    </div>

    <div class="topbar">
      <div class="greeting">
        <h1 class="greet-title"><span id="greetingWord">Good morning</span>, <span class="greet-name">Ahmad</span></h1>
        <p class="greet-sub">Find all the ZAtech invoices in one place - oh you can filter them as well :D</p>
      </div>

      <div class="hud">
        <div class="date-badge" id="todayBadge">--/--/----</div>
        <div class="search-group sg-closed">
          <button class="icon-btn" id="searchToggle" title="Search">ðŸ”Ž</button>
          <div class="search-anim" id="searchWrap" aria-hidden="true"><input id="searchInput" type="search" placeholder="Search clients, invoices, amountsâ€¦"/></div>
        </div>
        <button class="icon-btn" id="notifyBtn" title="Notifications">ðŸ””</button>
        <div class="account">
          <button class="account-btn" id="accountBtn" aria-expanded="false"><img class="avatar" src="./assets/img/user-icon.png" alt=""> Ahmad <span class="caret">â–¾</span></button>
          <div class="account-menu" id="accountMenu" role="menu">
            <a href="#" role="menuitem">Profile</a>
            <button id="logoutBtn" role="menuitem" class="menu-danger">Log out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- INVOICES -->
    <section id="invoices">
      <div class="card">
        <div class="card-head">
          <h4>Invoices</h4>
          <div class="filters">
            
            <select id="statusFilter" class="filter-select" style="margin-right:8px;">
              <option value="all" selected>All Status</option>
              <option value="Paid">Paid</option>
              <option value="Not Paid">Not Paid</option>
              <option value="Partial Payment">Partial Payment</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Sent">Sent</option>
            </select>

            <select id="dateFilter" class="filter-select">
              <option value="all" selected>All time</option>
              <option value="last30">Last 30 days</option>
              <option value="last90">Last 90 days</option>
              <option value="thisYear">This year</option>
              <option value="y2024">Year 2024</option>
              <option value="y2023">Year 2023</option>
              <option value="y2022">Year 2022</option>
            </select>
            <button id="newInvoiceBtn" class="btn2">New Invoice +</button>
          </div>
        </div>

        <table id="invoiceTable">
          <thead>
            <tr>
              <th data-sort="clientId">Client ID</th>
              <th data-sort="clientName">Client Name</th>
              <th data-sort="invoiceNo">Invoice #</th>
              <th data-sort="date">Date of Invoice</th>
              <th data-sort="amount">Total Invoiced Amount</th>
              <th data-sort="status">Status</th>
              <th data-sort="coverage">Coverage Period</th>
              <th data-sort="doc">Doc</th>
              <th data-sort="pdf">PDF</th>
              <th data-sort="note" style="width:64px;">Note</th>
            </tr>
          </thead>
          <tbody id="invoices-tbody"></tbody>
        </table>  
      </div>
    </section>
  </main>
</div>

<!-- ============ Create Invoice Modal (Form) ============ -->
<div id="invModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button class="close" id="invCloseBtn" aria-label="Close">Ã—</button>

    <h3>Create a New Invoice</h3>
    <p class="muted">Choose a client, set the service period and payment terms, add one or more services, then generate the invoice files.</p>

    <div id="invFormWrap">
      <div class="grid cols-3 inv-grid">
        <div class="field">
          <label for="invoiceClient" class="filter-label">Client</label>
          <div class="select-wrap">
            <select id="invoiceClient" class="filter-select"></select>
          </div>
        </div>

        <div class="field">
          <label for="invoiceCurrency" class="filter-label">Currency</label>
          <div class="select-wrap">
            <select id="invoiceCurrency" class="filter-select">
              <option value="JOD">JOD</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="CAD">CAD</option>
              <option value="GBP">GBP</option>
              <option value="SAR">SAR</option>
              <option value="AED">AED</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="invoiceTerms" class="filter-label">Payment Terms</label>
          <div class="select-wrap">
            <select id="invoiceTerms" class="filter-select">
              <option value="monthly" selected>Monthly</option>
              <option value="3m">3 Months</option>
              <option value="6m">6 Months</option>
              <option value="annual">Annual</option>
              <option value="one_time">One time</option>
            </select>
          </div>
          <small class="muted">Due date will be calculated from invoice date.</small>
        </div>
      </div>

      <div class="grid cols-2 inv-grid">
        <div class="field">
          <label for="serviceStart" class="filter-label">Service Start</label>
          <input type="date" id="serviceStart" class="edit-field show" />
        </div>
        <div class="field">
          <label for="serviceEnd" class="filter-label">Service End</label>
          <input type="date" id="serviceEnd" class="edit-field show" />
        </div>
      </div>

      <div class="services">
        <div class="services-head">
          <h4>Service Lines</h4>
          <button id="addServiceBtn" class="btn2 btn-dashed">+ Add another service</button>
        </div>

        <div id="serviceList" class="service-list"></div>

        <div class="totals">
          <div class="totals-item">Subtotal: <strong><span id="subtotalLabel">0.00</span></strong></div>
          <!-- <div class="totals-item">Total: <strong><span id="totalLabel">0.00</span></strong></div> -->
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button id="clearInvoiceBtn" class="btn2 btn-danger">Clear Invoice</button>
      <div class="spacer"></div>
      <button id="generateInvoiceBtn" class="btn2 btn-success">Generate Invoice</button>
      <button id="cancelInvBtn" class="btn2">Cancel</button>
    </div>
  </div>
</div>

<!-- ============ Success Modal ============ -->
<div id="invSuccessModal" class="modal" aria-hidden="true">
  <div class="modal-content modal-center">
    <button class="close" id="successCloseBtn" aria-label="Close">Ã—</button>

    <div class="success-top">
      <h5>Invoice generated successfully</h5>
    </div>

    <div class="success-actions centered">
      <a id="docxLink" class="btn2 btn-download" href="#" download>
        <img src="assets/img/word.png" alt="" class="btn-icon"> Download Word
      </a>
    </div>

    <p class="muted center">Your files were generated and uploaded. You can download the PDF or Word version below.</p>

    <div class="modal-actions centered">
      <button id="successDoneBtn" class="btn2 btn-success">Done</button>
    </div>
  </div>
</div>

<!-- ===== Upload PDF Modal ===== -->
<div id="pdfModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3 style="margin-bottom:10px;">Upload a PDF</h3>

    <form id="pdfForm">
      <input id="pdfFile" type="file" accept="application/pdf" required style="margin: 10px 0;">
      <div class="row-actions" style="gap:8px;">
        <button type="button" id="pdfCancel" class="mini">Cancel</button>
        <button type="submit" id="pdfSubmit" class="mini btn-amber">Upload</button>
      </div>

      <div id="pdfBusy" class="spinner" style="display:none;margin-top:10px;"></div>
      <p id="pdfMsg" class="small muted" style="margin-top:8px;"></p>
    </form>
  </div>
</div>



<div id="docxPreview" style="display:none;"></div>

</body>
</html>
